{% extends "htmlFiles/base.html" %}

{% block "container" %}

  <div class="container">
    <div class="chat-box">

      <!-- Header -->
      <header class="chat-header">
        <a href="{% url 'index' %}">
          <i class="fas fa-home home"></i>
        </a>
        <h3>{{friend.profile.name}}</h3>
        <div class="user-info">
          <img src="{{friend.profile.pic.url}}" alt="" class="avatar">
        </div>
      </header>

      <!-- Chat messages area -->
      <div class="messages-area colo" id="chat_body">

        {% for chat in chats %}

        {% if chat.msg_sender == user and chat.msg_reciever == profile %}
        <div class="message sent">{{chat}}</div>

        {% elif chat.msg_sender == profile and chat.msg_reciever == user %}
        <div class="message received">{{chat}}</div>

        {% endif %}

        {% endfor %}

      </div>

      <!-- Message input area -->
      <form class="message-input" id="messageForm" method="POST">

        {% csrf_token %}

        {{form.body}}
        <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>

      </form>

    </div>
  </div>

  <script>

        function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
      }
    return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    let form = document.getElementById("messageForm")

    form.addEventListener("submit", formSub)

    function formSub(){
      e.preventDefault()

      let chat_msg = document.getElementById("id_body").ariaValueMax
      console.log("box-value: ",msg)

      let url = "{% url 'send_msg' friend.profile.id %}"
      let data = { "msg": chat_msg } 

      fetch(url, {
        method: "POST",
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        console.log("formSub: ",data)

        let chat_box = document.createElement("div")
        let chat_body = document.getElementById("chat_body")
        chat_box.classList.add("message", "sent")
        chat_box.innerText = data
        chat_body.append(chat_box)
        document.getElementById("id_body").value = ""

      })

    }

    let counter = {{num}}

    function recieved_msg(){
      let url = "{% url 'rcvd_msg' friend.profile.id %}"

      fetch(url)
      .then(resp => resp.json())
      .then(data => {
        console.log(data)

        if(data.length == 0){}

        else{
          lst_msg = data[data.length - 1]

          if(data.length == counter){console.log("No new messages!")}

          else{
            let chat_box = document.createElement("div")
            let chat_body = document.getElementById("chat_body")
            chat_box.classList.add("message", "received")
            chat_box.innerText = lst_msg
            chat_body.append(chat_box)
          }
        }

        counter = data.length
      })
      .catch(err => console.log(err))

    }

    setInterval(recieved_msg, 3000)

  </script>

{% endblock %}